<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Itinerario di Viaggio con Mappa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Libreria Leaflet.js per la mappa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .content-hidden #main-app-container { display: none; }
        .card { border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; transition: all 0.3s ease-in-out; border-left-width: 4px; background-color: white; border-color: transparent; }
        .card:hover { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transform: translateY(-2px); }
        h1, h2, h3 { font-weight: 700; }
        input, textarea, select { width: 100%; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: white; }
        textarea { resize: none; overflow: hidden; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px #c7d2fe; }
        label { display: block; font-weight: 500; margin-bottom: 0.25rem; color: #4b5563; }
        .day-card { border-color: #a5b4fc; }
        .flight-card { background-color: #e0e7ff; border-color: #818cf8; }
        .tour-card { background-color: #dcfce7; border-color: #4ade80; }
        .image-placeholder { min-height: 220px; }
        .tab-button { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .tab-button.active { background-color: #4f46e5; color: white; }
        .tab-button:not(.active) { background-color: white; color: #4f46e5; border-color: #e0e7ff; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        .admin-only, .admin-only-flex, .admin-only-grid { display: none !important; }
        body.admin-mode .admin-only { display: inline-block !important; }
        body.admin-mode .admin-only-flex { display: flex !important; }
        body.admin-mode .admin-only-grid { display: grid !important; }
        body.admin-mode .user-only { display: none !important; }
        .readonly-text { background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.5rem 0.75rem; width: 100%; white-space: pre-wrap; word-break: break-word; color: #374151; min-height: 38px; }
        .day-card-wrapper, .flight-card, .tour-card { page-break-inside: avoid; }
        .calendar-day { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 50px; padding-top: 4px; }
        .calendar-day.trip-day { background-color: #dcfce7; color: #166534; font-weight: 600; cursor: pointer; border-radius: 0.5rem; transition: all 0.2s ease-in-out; }
        .calendar-day.trip-day:hover { background-color: #bbf7d0; transform: scale(1.05); }
        .calendar-day.today .day-number { box-shadow: 0 0 0 2px #6366f1; border-radius: 9999px; background-color: #e0e7ff; }
        .day-number { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .calendar-icons { font-size: 0.75rem; line-height: 1; margin-top: 2px; }
        .progress-bar { background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; overflow: hidden; display: flex; }
        .expense-item.on-splid { background-color: #f0f9ff; }
        .expense-item.booked { border-left: 4px solid #f59e0b; }
        .expense-item.paid { border-left: 4px solid #22c55e; }
        /* Stile per il contenitore della mappa */
        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            z-index: 1; /* Assicura che la mappa sia sotto i modali */
        }
        .leaflet-control-layers {
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid #ccc;
        }
        .leaflet-control-layers-base label, .leaflet-control-layers-overlays label {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @media print {
            body { background-color: white; }
            .no-print, .no-print * { display: none !important; }
            .card { box-shadow: none; border: 1px solid #e5e7eb; }
            .day-card-wrapper, .flight-card, .tour-card { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="content-hidden">

    <!-- Site Access Modal -->
    <div id="site-access-modal" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Accesso Richiesto</h2>
            <p class="text-gray-600 mb-6">Inserisci la password per visualizzare l'itinerario.</p>
            <form id="site-access-form">
                <input type="password" id="site-access-password-input" class="w-full px-4 py-2 border rounded-lg text-center focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <p id="site-access-password-error" class="text-red-500 text-sm mt-2 hidden">Password errata. Riprova.</p>
                <button type="submit" class="w-full mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Entra</button>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 no-print hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Accesso Amministratore</h2>
            <p class="text-gray-600 mb-6">Inserisci la password per modificare l'itinerario.</p>
            <form id="admin-form">
                <input type="password" id="admin-password-input" class="w-full px-4 py-2 border rounded-lg text-center focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <p id="admin-password-error" class="text-red-500 text-sm mt-2 hidden">Password errata. Riprova.</p>
                <button type="submit" class="w-full mt-4 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Accedi</button>
                <button type="button" id="admin-cancel-btn" class="w-full mt-2 px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
            </form>
        </div>
    </div>

    <!-- GitHub Image Modal -->
    <div id="github-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 z-40 items-center justify-center hidden no-print">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl mx-4 flex flex-col" style="height: 90vh;">
            <h2 class="text-2xl font-bold mb-4">Seleziona un'immagine da GitHub</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="github-user" placeholder="Nome utente GitHub" class="flex-grow">
                <input type="text" id="github-repo" placeholder="Nome repository (pubblico)" class="flex-grow">
                <button id="fetch-github-images-btn" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Carica Immagini</button>
            </div>
            <div id="github-feedback" class="text-green-600 text-sm mb-2"></div>
            <div id="github-image-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 overflow-y-auto p-2 bg-slate-100 rounded-lg flex-grow"></div>
            <button id="close-github-modal-btn" class="mt-4 w-full px-6 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors">Chiudi</button>
        </div>
    </div>
    
    <!-- PDF Quality Modal -->
    <div id="pdf-quality-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 no-print hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm mx-4">
            <h2 class="text-2xl font-bold mb-4">Scegli la qualit√† del PDF</h2>
            <p class="text-gray-600 mb-6">Una qualit√† pi√π bassa produce un file pi√π piccolo.</p>
            <div class="flex flex-col gap-4">
                <button data-quality="low" class="pdf-quality-btn w-full px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    Bassa <span class="block text-xs font-normal">(Veloce, file piccolo)</span>
                </button>
                <button data-quality="medium" class="pdf-quality-btn w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    Media <span class="block text-xs font-normal">(Consigliata, buon equilibrio)</span>
                </button>
                <button data-quality="high" class="pdf-quality-btn w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    Alta <span class="block text-xs font-normal">(Lenta, file grande)</span>
                </button>
            </div>
            <button type="button" id="pdf-quality-cancel-btn" class="w-full mt-6 px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
        </div>
    </div>

    <!-- Route Definition Modal -->
    <div id="route-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 no-print hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4 flex flex-col" style="max-height: 90vh;">
            <h2 class="text-2xl font-bold mb-4">Definisci Percorso Mappa</h2>
            <p class="text-gray-600 mb-6">Aggiungi le localit√† in ordine per creare il tracciato sulla mappa.</p>
            
            <div id="route-list" class="bg-slate-100 p-4 rounded-lg mb-4 overflow-y-auto flex-grow">
                <!-- Le tappe verranno inserite qui dinamicamente -->
            </div>

            <form id="add-route-stop-form" class="flex items-end gap-4">
                <div class="flex-grow">
                    <label for="route-location-select">Seleziona Tappa</label>
                    <select id="route-location-select"></select>
                </div>
                <button type="submit" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors h-10">Aggiungi</button>
            </form>

            <div class="flex justify-end gap-4 mt-8">
                <button type="button" id="route-cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Annulla</button>
                <button type="button" id="route-save-btn" class="px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Salva Percorso</button>
            </div>
        </div>
    </div>


    <!-- Main App Container -->
    <div id="main-app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10 relative">
             <div class="absolute top-0 right-0 no-print">
                <button id="admin-login-btn" class="user-only px-4 py-2 bg-gray-700 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-gray-800 transition-colors">Login Admin</button>
                <button id="admin-logout-btn" class="admin-only px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors">Logout</button>
            </div>
            
            <div id="main-title-container" class="mt-8 max-w-3xl mx-auto"></div>
             <h2 id="editor-subtitle" class="text-xl text-indigo-600 font-semibold mt-2 hidden">
                Editor Itinerario
            </h2>

            <div id="main-image-container" class="mt-6 max-w-4xl mx-auto relative">
                <img id="main-image-preview" class="w-full h-64 object-cover rounded-lg shadow-lg" alt="Immagine di copertina" style="display: none;">
                <div id="main-image-placeholder" class="w-full h-64 bg-slate-200 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-400" style="display: flex;">
                    <div class="text-center text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6v12"></path></svg>
                        <p class="text-lg font-semibold mb-3">Immagine di copertina</p>
                        <div class="admin-only-flex justify-center gap-4">
                            <label for="main-image-input" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50">Carica File</label>
                            <button class="github-open-btn px-4 py-2 bg-gray-800 text-white rounded-lg shadow-sm hover:bg-gray-900" data-target-id="main">da GitHub</button>
                        </div>
                    </div>
                </div>
                <div id="main-image-controls" class="admin-only-flex absolute top-2 right-2 gap-2 z-10" style="display: none;"></div>
                <input type="file" id="main-image-input" class="hidden" accept="image/*">
            </div>
        </header>
        
        <!-- Controls -->
        <div class="flex flex-wrap justify-center items-center gap-4 mb-8 no-print">
            <button id="pdf-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">Salva come PDF</button>
            <button id="export-json-btn" class="admin-only px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Esporta Dati (JSON)</button>
            <button id="import-json-btn" class="admin-only px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition-colors">Importa Dati (JSON)</button>
            <input type="file" id="import-json-input" class="hidden" accept="application/json">
            <button id="define-route-btn" class="admin-only px-6 py-2 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition-colors">Definisci Percorso</button>
            <button id="export-html-btn" class="admin-only px-6 py-2 bg-purple-600 text-white font-semibold rounded-lg shadow-md hover:bg-purple-700 transition-colors">Esporta HTML Pubblico</button>
            <button id="reset-btn" class="admin-only px-6 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition-colors">Reset Itinerario</button>
        </div>

        <!-- Calendario Riepilogativo -->
        <section id="calendar-summary" class="mb-10">
            <h2 class="text-2xl mb-4 border-b pb-2 border-gray-300 font-bold text-gray-700">Calendario del Viaggio</h2>
            
            <div id="date-controls" class="admin-only-flex card bg-slate-50 border-indigo-300 mb-6 flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow w-full">
                    <label for="start-date-input" class="font-semibold text-gray-700">Data Inizio</label>
                    <input type="date" id="start-date-input" class="mt-1">
                </div>
                <div class="flex-grow w-full">
                    <label for="end-date-input" class="font-semibold text-gray-700">Data Fine</label>
                    <input type="date" id="end-date-input" class="mt-1">
                </div>
                <button id="apply-dates-btn" class="w-full md:w-auto px-6 py-2.5 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Applica Date</button>
            </div>

            <div id="calendar-container" class="flex flex-wrap justify-center gap-8"></div>
        </section>

        <!-- Tabs -->
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8 no-print">
            <button id="tab-btn-itinerary" class="tab-button active">Itinerario</button>
            <button id="tab-btn-flights" class="tab-button">Voli</button>
            <button id="tab-btn-tours" class="tab-button">Tour</button>
            <button id="tab-btn-budget" class="tab-button">Budget</button>
            <button id="tab-btn-links" class="tab-button">Link Utili</button>
        </div>

        <!-- NUOVO: Contenitore Mappa -->
        <div id="map-container" class="mb-8 no-print">
            <h2 class="text-2xl mb-4 border-b pb-2 border-gray-300 font-bold text-gray-700">Mappa Interattiva</h2>
            <div id="map"></div>
        </div>

        <!-- Contenuto delle Schede -->
        <main id="main-content">
            <section id="itinerary-content" class="">
                <div id="itinerary-container"></div>
            </section>
            <section id="flights-content" class="hidden">
                <div id="flights-container"></div>
            </section>
             <section id="tours-content" class="hidden">
                <div id="tours-container"></div>
            </section>
            <section id="budget-content" class="hidden">
            </section>
            <section id="links-content" class="hidden">
            </section>
        </main>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SITE_ACCESS_PASSWORD = 'Filippine2026';
        const ADMIN_PASSWORD = 'Kerrickleo';
        const PDF_QUALITY_PRESETS = {
            low:    { scale: 1.5, jpegQuality: 0.6, text: 'Bassa' },
            medium: { scale: 2,   jpegQuality: 0.7, text: 'Media' },
            high:   { scale: 3,   jpegQuality: 0.8, text: 'Alta' }
        };
        const BUDGET_CATEGORIES = {
            'flights': '‚úàÔ∏è Voli',
            'hotels': 'üè® Alberghi',
            'tours': 'üó∫Ô∏è Tour & Attivit√†',
            'car_rental': 'üöó Noleggio Auto',
            'misc': 'üßæ Varie'
        };
        const TOUR_TYPES = {
            'boat': 'üö¢ Escursione in barca',
            'trekking': '‚õ∞Ô∏è Trekking',
            'cultural': 'üèõÔ∏è Tour culturale'
        };
        const TIMEZONES = [
            { name: "UTC-12:00", offset: -12 }, { name: "UTC-11:00", offset: -11 },
            { name: "UTC-10:00 (HST)", offset: -10 }, { name: "UTC-09:00 (AKT)", offset: -9 },
            { name: "UTC-08:00 (PST)", offset: -8 }, { name: "UTC-07:00 (MST)", offset: -7 },
            { name: "UTC-06:00 (CST)", offset: -6 }, { name: "UTC-05:00 (EST)", offset: -5 },
            { name: "UTC-04:00 (AST)", offset: -4 }, { name: "UTC-03:00 (ART)", offset: -3 },
            { name: "UTC-02:00", offset: -2 }, { name: "UTC-01:00", offset: -1 },
            { name: "UTC+00:00 (GMT)", offset: 0 }, { name: "UTC+01:00 (CET)", offset: 1 },
            { name: "UTC+02:00 (EET)", offset: 2 }, { name: "UTC+03:00 (MSK)", offset: 3 },
            { name: "UTC+04:00", offset: 4 }, { name: "UTC+05:00 (PKT)", offset: 5 },
            { name: "UTC+05:30 (IST)", offset: 5.5 }, { name: "UTC+06:00", offset: 6 },
            { name: "UTC+07:00 (WIB)", offset: 7 }, { name: "UTC+08:00 (HKT/PHT)", offset: 8 },
            { name: "UTC+09:00 (JST)", offset: 9 }, { name: "UTC+09:30 (ACST)", offset: 9.5 },
            { name: "UTC+10:00 (AEST)", offset: 10 }, { name: "UTC+11:00", offset: 11 },
            { name: "UTC+12:00 (NZST)", offset: 12 }, { name: "UTC+13:00", offset: 13 },
            { name: "UTC+14:00", offset: 14 }
        ];

        // --- SVG ICONS ---
        const TRASH_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
        const PENCIL_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>`;

        // --- GLOBAL VARIABLES ---
        let isAdminMode = false;
        let currentData = null;
        const DATA_STORAGE_KEY = 'travelPlannerData_Filippine2';
        let map = null; 
        let tempRoute = [];

        // --- DEFAULT DATA (FALLBACK ONLY) ---
        const defaultFullData = {
            main: { title: "Nuovo Itinerario", image: "" },
            flights: [],
            itinerary: [],
            tours: [],
            budget: { total: 0, expenses: [] },
            usefulLinks: [],
            route: []
        };

        // --- GITHUB MODAL STATE ---
        let currentImageTargetId = null;

        // --- FUNZIONI MAPPA ---
        function initializeMap(itineraryData) {
            if (map) { map.remove(); map = null; }
            if (!document.getElementById('map')) return;

            const streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            });

            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            const topoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
	            maxZoom: 17,
	            attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
            });

            map = L.map('map', {
                center: [36.2048, 138.2529],
                zoom: 5,
                layers: [streetMap]
            });

            const baseMaps = {
                "Stradale": streetMap,
                "Satelittare": satelliteMap,
                "Topografica": topoMap
            };
            
            const pathLayer = L.layerGroup();
            const locationsLayer = L.layerGroup();
            const accommodationLayer = L.layerGroup();

            const formatDateForPopup = (dateString) => {
                const [_, month, day] = dateString.split('-');
                return `${day}/${month}`;
            };
            
            const locationsMap = new Map();
            const accommodationsMap = new Map();

            itineraryData.forEach((item) => {
                if (item.location && item.location_coords && item.location_coords.lat) {
                    const key = `${item.location_coords.lat},${item.location_coords.lng}`;
                    if (!locationsMap.has(key)) {
                        locationsMap.set(key, { coords: item.location_coords, names: new Set(), dates: new Map() });
                    }
                    const entry = locationsMap.get(key);
                    entry.names.add(item.location);
                    entry.dates.set(item.date, item.date);
                }
                if (item.accommodation && item.accommodation_coords && item.accommodation_coords.lat) {
                    const key = `${item.accommodation_coords.lat},${item.accommodation_coords.lng}`;
                     if (!accommodationsMap.has(key)) {
                        accommodationsMap.set(key, { coords: item.accommodation_coords, names: new Set(), dates: new Map() });
                    }
                    const entry = accommodationsMap.get(key);
                    entry.names.add(item.accommodation);
                    entry.dates.set(item.date, item.date);
                }
            });

            const locationMarkers = [];
            locationsMap.forEach(loc => {
                const sortedDates = [...loc.dates.keys()].sort();
                const dateLinks = sortedDates.map(date => `<a href="#" class="popup-date-link text-indigo-600 hover:underline p-1" data-date="${date}">${formatDateForPopup(date)}</a>`).join(', ');
                const title = [...loc.names].join(' / ');
                const popupContent = `<b>${title}</b><br><div class="mt-2"><b>Date:</b> ${dateLinks}</div>`;
                const marker = L.marker([loc.coords.lat, loc.coords.lng], {
                    icon: new L.Icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).bindPopup(popupContent);
                locationsLayer.addLayer(marker);
                locationMarkers.push(marker);
            });
            
            accommodationsMap.forEach(loc => {
                const sortedDates = [...loc.dates.keys()].sort();
                const dateLinks = sortedDates.map(date => `<a href="#" class="popup-date-link text-indigo-600 hover:underline p-1" data-date="${date}">${formatDateForPopup(date)}</a>`).join(', ');
                const title = [...loc.names].join(' / ');
                const popupContent = `<b>${title}</b><br><div class="mt-2"><b>Date:</b> ${dateLinks}</div>`;
                const marker = L.marker([loc.coords.lat, loc.coords.lng], {
                    icon: new L.Icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    })
                }).bindPopup(popupContent);
                accommodationLayer.addLayer(marker);
            });
            
            const routePoints = (currentData.route || [])
                .map(routeName => {
                    const locationData = itineraryData.find(item => item.location === routeName);
                    return locationData ? locationData.location_coords : null;
                })
                .filter(coords => coords && coords.lat && coords.lng);
            
            if (routePoints.length > 1) {
                const polyline = L.polyline(routePoints, { color: 'red', weight: 3, opacity: 0.7 });
                pathLayer.addLayer(polyline);
            }

            const overlayMaps = {
                "<i class='pr-1'>&#128205;</i> Localit√†": locationsLayer,
                "<i class='pr-1'>&#127759;</i> Percorso": pathLayer,
                "<i class='pr-1'>&#127974;</i> Alloggi": accommodationLayer
            };

            L.control.layers(baseMaps, overlayMaps).addTo(map);
            locationsLayer.addTo(map);
            pathLayer.addTo(map);

            const isInItaly = (lat, lng) => lat > 36 && lat < 47 && lng > 6 && lng < 19;
            const markersForBounds = locationMarkers.filter(marker => !isInItaly(marker.getLatLng().lat, marker.getLatLng().lng));

            if (markersForBounds.length > 0) {
                map.fitBounds(L.featureGroup(markersForBounds).getBounds().pad(0.1));
            } else if (locationMarkers.length > 0) {
                map.fitBounds(L.featureGroup(locationMarkers).getBounds().pad(0.1));
            }
        }

        function centerMapOnLocation(lat, lng) {
            if (map && lat && lng) {
                map.flyTo([lat, lng], 14, { duration: 1 });
            }
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
        function formatOffset(offset) { const sign = offset >= 0 ? '+' : '-'; const absOffset = Math.abs(offset); const hours = String(Math.floor(absOffset)).padStart(2, '0'); const minutes = String((absOffset % 1) * 60).padStart(2, '0'); return `${sign}${hours}:${minutes}`; }
        
        function calculateDurationString(depTimeValue, arrTimeValue, depTzOffset, arrTzOffset) {
            if (!depTimeValue || !arrTimeValue) return '';
            try {
                let depDate, arrDate;
                if (depTzOffset !== null && arrTzOffset !== null) {
                    depDate = new Date(`${depTimeValue}:00${formatOffset(depTzOffset)}`);
                    arrDate = new Date(`${arrTimeValue}:00${formatOffset(arrTzOffset)}`);
                } else {
                    depDate = new Date(depTimeValue);
                    arrDate = new Date(arrTimeValue);
                }
                let diff = arrDate.getTime() - depDate.getTime();
                if (isNaN(diff) || diff < 0) return "";
                
                const diffDays = Math.floor(diff / 86400000);
                diff -= diffDays * 86400000;
                const diffHours = Math.floor(diff / 3600000);
                diff -= diffHours * 3600000;
                const diffMinutes = Math.round(diff / 60000);
                
                let durationString = 'Durata: ';
                if (diffDays > 0) durationString += `${diffDays}g `;
                durationString += `${diffHours}h ${diffMinutes}m`;
                return durationString;
            } catch(e) {
                return "";
            }
        }

        function updateGmapsLink(inputElement) {
            const link = inputElement.parentElement.querySelector('.gmaps-link');
            if (link) link.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(inputElement.value)}`;
        }
        
        function autoGrowTextarea(element) { if(element) { element.style.height = 'auto'; element.style.height = (element.scrollHeight) + 'px'; } }
        async function compressImage(file, maxWidth = 1280, maxHeight = 1280, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = (error) => reject(error);
                };
                reader.onerror = (error) => reject(error);
            });
        }
        
        // --- DATA MANAGEMENT FUNCTIONS ---
        function saveData() {
            try {
                const dataToSave = buildDataObjectFromDOM();
                currentData = dataToSave;
                localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (e) {
                console.error("Errore nel salvataggio dei dati:", e);
            }
        }

        async function loadData() {
            try {
                console.log("Caricamento dati da itinerary.json...");
                const response = await fetch(`itinerary.json?v=${new Date().getTime()}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonData = await response.json();
                console.log("Dati caricati con successo da itinerary.json.");
                if (!jsonData.route) jsonData.route = []; // Initialize route if not present
                localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(jsonData));
                return jsonData;

            } catch (e) {
                console.error("Errore nel caricamento dei dati dal server:", e);
                const savedData = localStorage.getItem(DATA_STORAGE_KEY);
                if (savedData) {
                    console.log("Caricamento dal server fallito, utilizzo i dati da localStorage come fallback.");
                    const parsedData = JSON.parse(savedData);
                    if (!parsedData.route) parsedData.route = [];
                    return parsedData;
                }
                console.log("Nessun dato locale disponibile, utilizzo i dati di default.");
                return JSON.parse(JSON.stringify(defaultFullData));
            }
        }
        
        function buildDataObjectFromDOM() {
            if (!isAdminMode) return currentData; 

            const data = {
                main: {},
                flights: [],
                itinerary: [],
                tours: [],
                budget: currentData.budget,
                usefulLinks: currentData.usefulLinks,
                route: currentData.route || []
            };

            data.main.title = document.getElementById('main-title-input')?.value || currentData.main.title;
            data.main.image = document.getElementById('main-image-preview').src;

            document.querySelectorAll('#flights-container .flight-card').forEach(card => {
                const idPrefix = card.dataset.idprefix;
                data.flights.push({
                    idPrefix,
                    title: document.getElementById(`flight-${idPrefix}-title`).value,
                    depAirport: document.getElementById(`${idPrefix}-dep-airport`).value,
                    arrAirport: document.getElementById(`${idPrefix}-arr-airport`).value,
                    depTime: document.getElementById(`${idPrefix}-dep-time`).value,
                    arrTime: document.getElementById(`${idPrefix}-arr-time`).value,
                    depTz: parseFloat(document.getElementById(`${idPrefix}-dep-tz`).value),
                    arrTz: parseFloat(document.getElementById(`${idPrefix}-arr-tz`).value),
                });
            });

            document.querySelectorAll('#itinerary-container .day-card-wrapper').forEach((card, index) => {
                const dayId = `day${index + 1}`;
                const originalItem = currentData.itinerary[index] || {};
                data.itinerary.push({
                    date: document.getElementById(`${dayId}-date`).value,
                    location: document.getElementById(`${dayId}-location`).value,
                    isFlight: document.getElementById(`${dayId}-flight-check`).checked,
                    isCruise: document.getElementById(`${dayId}-cruise-check`).checked,
                    accommodation: document.getElementById(`${dayId}-accommodation`).value,
                    activities: document.getElementById(`${dayId}-activities`).value,
                    image: document.getElementById(`${dayId}-image-preview`).src,
                    location_coords: originalItem.location_coords, // Preserve coords
                    accommodation_coords: originalItem.accommodation_coords // Preserve coords
                });
            });

            document.querySelectorAll('#tours-container .tour-card').forEach(card => {
                const tourId = card.dataset.id;
                data.tours.push({
                    id: parseInt(tourId),
                    title: document.getElementById(`tour-${tourId}-title`).value,
                    depTime: document.getElementById(`tour-${tourId}-dep-time`).value,
                    arrTime: document.getElementById(`tour-${tourId}-arr-time`).value,
                    type: document.getElementById(`tour-${tourId}-type`).value,
                    description: document.getElementById(`tour-${tourId}-description`).value,
                });
            });

            return data;
        }

        function resetItinerary() {
            if (confirm("Sei sicuro di voler cancellare TUTTI i dati e ripristinare l'itinerario originale? L'operazione √® irreversibile.")) {
                localStorage.removeItem(DATA_STORAGE_KEY);
                sessionStorage.removeItem('siteAccessGranted');
                sessionStorage.removeItem('isAdmin');
                location.reload();
            }
        }
        
        function exportJSON() {
            saveData();
            const dataStr = JSON.stringify(currentData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'itinerary.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleJSONImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && importedData.main && importedData.itinerary && importedData.budget) {
                        if (confirm("Importando questo file, tutti i dati attuali non salvati verranno sovrascritti. Continuare?")) {
                            currentData = importedData;
                            localStorage.setItem(DATA_STORAGE_KEY, JSON.stringify(currentData));
                            renderApp(currentData, isAdminMode);
                            alert("Dati importati con successo!");
                        }
                    } else {
                        alert("File JSON non valido o malformato.");
                    }
                } catch (error) {
                    console.error("Errore nel parsing del file JSON:", error);
                    alert("Errore durante la lettura del file. Assicurati che sia un file JSON valido.");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        async function exportHTML() {
            alert("Questa funzione ora esporta una versione 'pubblica' del sito. Per salvare i dati, usa 'Esporta Dati (JSON)'.");
            saveData(); 
            const latestData = await loadData();
            let htmlString = document.documentElement.outerHTML;

            const dataScript = `<script>const embeddedData = ${JSON.stringify(latestData, null, 2)};<\/script>`;
            htmlString = htmlString.replace('</head>', `${dataScript}</head>`);
            
            const loadDataRegex = /async function loadData\(\) {[\s\S]*?}/;
            const newLoadDataFunc = `async function loadData() { 
                    console.log("Dati caricati dalla variabile embedded.");
                    return window.embeddedData; 
                }`;

            if (htmlString.match(loadDataRegex)) {
                 htmlString = htmlString.replace(loadDataRegex, newLoadDataFunc);
            } else {
                console.error("Impossibile trovare la funzione loadData da sostituire nell'HTML esportato.");
            }

            htmlString = htmlString.replace(/<body class="[^"]*">/, '<body class="content-hidden">');
            htmlString = htmlString.replace(/(<div id="site-access-modal"[^>]*class=")([^"]*)(")/, (match, p1, p2, p3) => {
                const classes = p2.split(' ').filter(c => c !== 'hidden').join(' ');
                return `${p1}${classes}${p3}`;
            });
            const blob = new Blob([htmlString], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'index_pubblico.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        }

        async function saveAsPDF(quality = PDF_QUALITY_PRESETS.medium) {
            const pdfBtn = document.getElementById('pdf-btn');
            pdfBtn.textContent = `Generazione PDF (${quality.text})...`;
            pdfBtn.disabled = true;

            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pdfWidth - (margin * 2);
            let y = margin;

            const addElementToPdf = async (element) => {
                const canvas = await html2canvas(element, { scale: quality.scale, useCORS: true, logging: false, width: element.offsetWidth, windowWidth: element.offsetWidth });
                const imgData = canvas.toDataURL('image/jpeg', quality.jpegQuality);
                const imgHeight = (canvas.height * contentWidth) / canvas.width;
                if (y + imgHeight > pdfHeight - margin) { pdf.addPage(); y = margin; }
                pdf.addImage(imgData, 'JPEG', margin, y, contentWidth, imgHeight);
                y += imgHeight + 5;
            };
            
            const printContainer = document.createElement('div');
            printContainer.style.cssText = 'position: absolute; left: -9999px; width: 1024px; background-color: white;';
            document.body.appendChild(printContainer);

            try {
                const prepareElementForPrint = (originalElement) => {
                    const clone = originalElement.cloneNode(true);
                    clone.style.padding = '10px';
                    clone.style.marginBottom = '0';
                    clone.classList.remove('hidden');
                    clone.querySelectorAll('.no-print, button, input[type="file"], label[for*="-image-input"], .image-controls').forEach(el => el.remove());
                    clone.querySelectorAll('input, textarea, select').forEach(el => {
                        const p = document.createElement('div');
                        let value = el.value;
                        if (el.tagName === 'SELECT') value = el.options[el.selectedIndex].text;
                        else if (el.type === 'date') value = new Date(value + 'T00:00:00').toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
                        else if (el.type === 'datetime-local') value = new Date(value).toLocaleString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        p.innerHTML = (value || '').replace(/\n/g, '<br>');
                        p.className = 'readonly-text';
                        el.parentNode.replaceChild(p, el);
                    });
                    clone.querySelectorAll('img[id$="-preview"]').forEach(img => { if (img.src && (img.src.startsWith('data:') || img.src.startsWith('http'))) { img.style.display = 'block'; img.classList.remove('hidden'); } else { img.remove(); } });
                    clone.querySelectorAll('.image-placeholder').forEach(el => el.remove());
                    clone.querySelectorAll('.card').forEach(c => { c.style.boxShadow = 'none'; c.style.border = '1px solid #e5e7eb'; c.style.transform = 'none'; });
                    printContainer.appendChild(clone);
                    return clone;
                };

                await addElementToPdf(prepareElementForPrint(document.querySelector('header')));
                printContainer.innerHTML = '';
                await addElementToPdf(prepareElementForPrint(document.getElementById('calendar-summary')));
                printContainer.innerHTML = '';
                
                pdf.addPage(); y = margin;
                const itineraryTitle = document.createElement('h2');
                itineraryTitle.className = 'text-2xl mb-4 border-b pb-2 font-bold text-gray-700';
                itineraryTitle.textContent = 'Itinerario Dettagliato';
                await addElementToPdf(prepareElementForPrint(itineraryTitle));
                printContainer.innerHTML = '';

                for (const card of document.querySelectorAll('#itinerary-container .day-card-wrapper')) {
                    await addElementToPdf(prepareElementForPrint(card));
                    printContainer.innerHTML = '';
                }

                if (document.querySelector('#flights-content .flight-card')) {
                    pdf.addPage(); y = margin;
                    const flightsTitle = document.createElement('h2');
                    flightsTitle.className = 'text-2xl mb-4 border-b pb-2 font-bold text-gray-700';
                    flightsTitle.textContent = 'Riepilogo Voli';
                    await addElementToPdf(prepareElementForPrint(flightsTitle));
                    printContainer.innerHTML = '';
                    for (const card of document.querySelectorAll('#flights-content .flight-card')) {
                        await addElementToPdf(prepareElementForPrint(card));
                        printContainer.innerHTML = '';
                    }
                }

                if (document.querySelector('#tours-content .tour-card')) {
                    pdf.addPage(); y = margin;
                    const toursTitle = document.createElement('h2');
                    toursTitle.className = 'text-2xl mb-4 border-b pb-2 font-bold text-gray-700';
                    toursTitle.textContent = 'Riepilogo Tour';
                    await addElementToPdf(prepareElementForPrint(toursTitle));
                    printContainer.innerHTML = '';
                    for (const card of document.querySelectorAll('#tours-content .tour-card')) {
                        await addElementToPdf(prepareElementForPrint(card));
                        printContainer.innerHTML = '';
                    }
                }

                if(document.getElementById('budget-content').innerHTML.trim() !== ''){
                    pdf.addPage(); y = margin;
                    await addElementToPdf(prepareElementForPrint(document.getElementById('budget-content')));
                    printContainer.innerHTML = '';
                }
                
                const titleEl = document.getElementById('main-title-input') || document.querySelector('#main-title-container h1');
                const title = titleEl.value || titleEl.textContent;
                pdf.save(`itinerario_${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.pdf`);

            } catch (error) {
                console.error("Errore durante la generazione del PDF:", error);
                alert("Si √® verificato un errore durante la generazione del PDF. Controlla la console per i dettagli.");
            } finally {
                document.body.removeChild(printContainer);
                pdfBtn.textContent = 'Salva come PDF';
                pdfBtn.disabled = false;
            }
        }
        
        // --- FUNZIONI DI RENDER ---
        function renderApp(data, adminMode) {
            isAdminMode = adminMode;
            document.body.classList.toggle('admin-mode', adminMode);
            
            const mainTitleContainer = document.getElementById('main-title-container');
            const editorSubtitle = document.getElementById('editor-subtitle');

            if (adminMode) {
                mainTitleContainer.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-gray-800"><input type="text" id="main-title-input" value="${data.main.title}" class="w-full text-center border-0 focus:ring-0 bg-transparent p-0 m-0 font-bold text-3xl md:text-4xl"></h1>`;
                editorSubtitle.classList.remove('hidden');
            } else {
                mainTitleContainer.innerHTML = `<h1 class="text-3xl md:text-4xl font-bold text-gray-800">${data.main.title}</h1>`;
                editorSubtitle.classList.add('hidden');
            }

            renderImage('main', data.main.image);
            createDetailedItinerary(data.itinerary, adminMode);
            createFlightsList(data.flights, adminMode);
            renderTours(data.tours, adminMode);
            renderBudget(data.budget, adminMode);
            renderUsefulLinks(data.usefulLinks, adminMode);
            updateCalendar(data.itinerary);

            if (adminMode && data.itinerary && data.itinerary.length > 0) {
                data.itinerary.sort((a, b) => new Date(a.date) - new Date(b.date));
                document.getElementById('start-date-input').value = data.itinerary[0].date;
                document.getElementById('end-date-input').value = data.itinerary[data.itinerary.length - 1].date;
            }

            initializeMap(data.itinerary);
            setupDynamicEventListeners();
        }
        
        function renderImage(targetId, imageUrl) {
            const preview = document.getElementById(`${targetId}-image-preview`);
            const placeholder = document.getElementById(`${targetId}-image-placeholder`);
            const controls = document.getElementById(`${targetId}-image-controls`);
            const hasImage = imageUrl && (imageUrl.startsWith('data:') || imageUrl.startsWith('http'));

            if (preview) { preview.src = hasImage ? imageUrl : ''; preview.style.display = hasImage ? 'block' : 'none'; }
            if (placeholder) placeholder.style.display = hasImage ? 'none' : 'flex';
            
            if (controls) {
                controls.style.display = (hasImage && isAdminMode) ? 'flex' : 'none';
                if (hasImage && isAdminMode) {
                    controls.innerHTML = `
                        <button class="github-open-btn p-2 bg-white text-gray-800 rounded-full shadow-md hover:bg-gray-200" data-target-id="${targetId}" title="Cambia immagine">${PENCIL_ICON_SVG}</button>
                        <button class="remove-image-btn p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600" data-target-id="${targetId}" title="Rimuovi immagine">${TRASH_ICON_SVG}</button>`;
                }
            }
        }

        function updateCalendar(itineraryData) {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            if (!itineraryData || itineraryData.length === 0) return;
            
            itineraryData.sort((a, b) => new Date(a.date) - new Date(b.date));
            const tripEvents = new Map(itineraryData.map(item => [item.date, `${item.isFlight ? '‚úàÔ∏è' : ''}${item.isCruise ? 'üö¢' : ''}`]).filter(entry => entry[1]));
            const tripDates = new Set(itineraryData.map(item => item.date));
            const firstDate = new Date(itineraryData[0].date + 'T12:00:00Z');
            const lastDate = new Date(itineraryData[itineraryData.length - 1].date + 'T12:00:00Z');
            let currentDate = new Date(Date.UTC(firstDate.getUTCFullYear(), firstDate.getUTCMonth(), 1));

            while (currentDate <= lastDate) {
                const year = currentDate.getUTCFullYear();
                const month = currentDate.getUTCMonth();
                const monthContainer = document.createElement('div');
                monthContainer.className = 'w-full md:w-auto';
                monthContainer.innerHTML = `
                    <h3 class="text-xl font-semibold text-center mb-2 text-indigo-700">${new Date(year, month).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' })}</h3>
                    <div class="grid grid-cols-7 gap-1 text-center text-sm">
                        ${['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom'].map(day => `<div class="font-bold text-gray-500">${day}</div>`).join('')}
                    </div>`;
                const grid = monthContainer.querySelector('.grid');
                const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
                for (let i = 0; i < firstDayOfMonth; i++) grid.insertAdjacentHTML('beforeend', '<div></div>');

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const thisDate = new Date(Date.UTC(year, month, day));
                    const dateString = thisDate.toISOString().split('T')[0];
                    const isTripDay = tripDates.has(dateString);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    if (isTripDay) {
                        dayEl.classList.add('trip-day');
                        dayEl.dataset.date = dateString;
                    }
                    if (thisDate.toDateString() === new Date().toDateString()) dayEl.classList.add('today');
                    dayEl.innerHTML = `<span class="day-number">${day}</span>${isTripDay && tripEvents.has(dateString) ? `<div class="calendar-icons">${tripEvents.get(dateString)}</div>` : ''}`;
                    grid.appendChild(dayEl);
                }
                container.appendChild(monthContainer);
                currentDate.setUTCMonth(currentDate.getUTCMonth() + 1);
            }
        }

        function createDetailedItinerary(data, adminMode) {
            const container = document.getElementById('itinerary-container');
            const mapIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>`;
            const centerMapIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 5.943 7.523 4 10 4s6.268 1.943 9.542 6c-3.274 4.057-7.064 6-9.542 6S3.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
            
            container.innerHTML = data.map((item, index) => {
                const dayId = `day${index + 1}`;
                const dateObj = new Date(item.date + 'T12:00:00Z');
                const dateString = dateObj.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                const accommodationLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.accommodation)}`;
                const hasImage = item.image && (item.image.startsWith('data:') || item.image.startsWith('http'));
                
                const centerMapButton = (item.location_coords && item.location_coords.lat) 
                    ? `<button class="center-map-btn p-2 text-gray-400 hover:text-indigo-600" title="Mostra sulla mappa" data-lat="${item.location_coords.lat}" data-lng="${item.location_coords.lng}">${centerMapIconSvg}</button>`
                    : '';

                return `<div class="card day-card flex flex-col md:flex-row gap-6 items-stretch day-card-wrapper" data-date="${item.date}">
                        <div class="w-full md:w-1/2 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">${dateString} (Giorno ${index + 1})</h3>
                                ${centerMapButton}
                            </div>
                            <div class="grid grid-cols-1 gap-4 flex-grow">
                                ${adminMode ? `<div><label for="${dayId}-date">Data</label><input type="date" id="${dayId}-date" value="${item.date}"></div><div><label for="${dayId}-location">Localit√†</label><input type="text" id="${dayId}-location" value="${item.location}"></div><div><label for="${dayId}-accommodation">Alloggio</label><div class="relative flex items-center"><input type="text" id="${dayId}-accommodation" value="${item.accommodation}" class="pr-10"><a href="${accommodationLink}" target="_blank" class="gmaps-link absolute right-0 top-0 h-full flex items-center px-3 text-gray-400 hover:text-indigo-600" data-input-id="${dayId}-accommodation" title="Apri in Google Maps">${mapIconSvg}</a></div></div><div class="flex-grow flex flex-col"><label for="${dayId}-activities">Attivit√†</label><textarea id="${dayId}-activities">${item.activities}</textarea></div><div class="flex items-center gap-6 mt-2"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="${dayId}-flight-check" ${item.isFlight ? 'checked' : ''} class="w-5 h-5 rounded text-indigo-600 focus:ring-indigo-500"> <span>‚úàÔ∏è Volo</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="${dayId}-cruise-check" ${item.isCruise ? 'checked' : ''} class="w-5 h-5 rounded text-sky-600 focus:ring-sky-500"> <span>üö¢ Crociera</span></label></div>` : `<div><label>Localit√†</label><div class="readonly-text">${item.location}</div></div><div><label>Alloggio</label><div class="flex items-center justify-between readonly-text"><span class="flex-grow">${item.accommodation}</span><a href="${accommodationLink}" target="_blank" title="Apri in Google Maps" class="p-2 text-gray-400 hover:text-indigo-600">${mapIconSvg}</a></div></div><div class="flex-grow flex flex-col"><label>Attivit√†</label><div class="readonly-text">${item.activities.replace(/\n/g, '<br>')}</div></div>`}
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 relative">
                            <img id="${dayId}-image-preview" class="object-cover w-full h-full rounded-lg" style="display: ${hasImage ? 'block' : 'none'}" src="${hasImage ? item.image : ''}" alt="Anteprima"/>
                            <div id="${dayId}-image-placeholder" class="image-placeholder w-full h-full bg-slate-200 rounded-lg items-center justify-center border-2 border-dashed border-gray-400" style="display: ${hasImage ? 'none' : 'flex'}">
                                 <div class="text-center text-gray-600"><div class="admin-only-flex justify-center gap-4"><label for="${dayId}-image-input" class="px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm cursor-pointer hover:bg-gray-50 text-sm">Carica File</label><button class="github-open-btn px-4 py-2 bg-gray-800 text-white rounded-lg shadow-sm hover:bg-gray-900 text-sm" data-target-id="${dayId}">da GitHub</button></div><p class="user-only font-semibold">Nessuna immagine</p></div>
                            </div>
                            <div id="${dayId}-image-controls" class="image-controls admin-only-flex absolute top-2 right-2 gap-2 z-10" style="display: ${hasImage && adminMode ? 'flex' : 'none'};"></div>
                            <input type="file" id="${dayId}-image-input" class="hidden" accept="image/*">
                        </div>
                    </div>`;
            }).join('');
        }

        function createFlightsList(data, adminMode) {
            const container = document.getElementById('flights-container');
            const trashIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
            const createTimezoneSelect = (id, selectedOffset) => `<select id="${id}">${TIMEZONES.map(tz => `<option value="${tz.offset}" ${tz.offset == selectedOffset ? 'selected' : ''}>${tz.name}</option>`).join('')}</select>`;
            const flightCardsHTML = data.map(flight => {
                const idPrefix = flight.idPrefix;
                const depTzName = TIMEZONES.find(tz => tz.offset == flight.depTz)?.name || `UTC${flight.depTz >= 0 ? '+' : ''}${flight.depTz}`;
                const arrTzName = TIMEZONES.find(tz => tz.offset == flight.arrTz)?.name || `UTC${flight.arrTz >= 0 ? '+' : ''}${flight.arrTz}`;
                return `<div class="card flight-card" data-idprefix="${idPrefix}">
                        <div class="flex justify-between items-start mb-4">
                             <h3 class="text-xl font-semibold text-indigo-700 flex-grow"><span>‚úàÔ∏è ${adminMode ? `<input type="text" id="flight-${idPrefix}-title" value="${flight.title}" class="inline-block w-auto p-1 bg-transparent border-0 border-b focus:ring-0 font-semibold text-xl text-indigo-700">` : flight.title}</span></h3>
                            <button data-flight-id="${idPrefix}" class="delete-flight-btn admin-only text-gray-400 hover:text-red-500 p-1" title="Rimuovi volo">${trashIconSvg}</button>
                        </div>
                        ${adminMode ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="${idPrefix}-dep-airport">Aeroporto Partenza</label><input type="text" id="${idPrefix}-dep-airport" value="${flight.depAirport}"></div><div><label for="${idPrefix}-arr-airport">Aeroporto Arrivo</label><input type="text" id="${idPrefix}-arr-airport" value="${flight.arrAirport}"></div><div><label for="${idPrefix}-dep-time">Data/Ora Partenza</label><input type="datetime-local" id="${idPrefix}-dep-time" value="${flight.depTime}"></div><div><label for="${idPrefix}-arr-time">Data/Ora Arrivo</label><input type="datetime-local" id="${idPrefix}-arr-time" value="${flight.arrTime}"></div><div><label for="${idPrefix}-dep-tz">Fuso Orario Partenza</label>${createTimezoneSelect(`${idPrefix}-dep-tz`, flight.depTz)}</div><div><label for="${idPrefix}-arr-tz">Fuso Orario Arrivo</label>${createTimezoneSelect(`${idPrefix}-arr-tz`, flight.arrTz)}</div></div>` : `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label>Aeroporto Partenza</label><div class="readonly-text">${flight.depAirport}</div></div><div><label>Aeroporto Arrivo</label><div class="readonly-text">${flight.arrAirport}</div></div><div><label>Data/Ora Partenza</label><div class="readonly-text">${flight.depTime ? new Date(flight.depTime).toLocaleString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</div></div><div><label>Data/Ora Arrivo</label><div class="readonly-text">${flight.arrTime ? new Date(flight.arrTime).toLocaleString('it-IT', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : ''}</div></div><div><label>Fuso Orario Partenza</label><div class="readonly-text">${depTzName}</div></div><div><label>Fuso Orario Arrivo</label><div class="readonly-text">${arrTzName}</div></div></div>`}
                    </div>`;
            }).join('');
            const summaryTableRows = data.map(flight => `<tr class="border-b last:border-b-0"><td class="py-2 pr-4 font-medium">${flight.title}</td><td class="py-2 pl-4 text-right">${calculateDurationString(flight.depTime, flight.arrTime, flight.depTz, flight.arrTz)}</td></tr>`).join('');
            container.innerHTML = `${flightCardsHTML}<div class="flex justify-center mt-6"><button id="add-flight-btn" class="admin-only px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Aggiungi Volo</button></div><div class="card mt-8"><h3 class="text-xl font-semibold text-gray-700 mb-4">Riepilogo Durata Voli</h3><table id="flights-summary-table" class="w-full text-sm"><thead><tr class="border-b-2"><th class="text-left font-semibold pb-2">Volo</th><th class="text-right font-semibold pb-2">Durata</th></tr></thead><tbody>${summaryTableRows}</tbody></table></div>`;
        }

        function renderTours(data, adminMode) {
            const container = document.getElementById('tours-container');
            const tourCards = (data || []).map(tour => {
                const tourId = tour.id;
                const icon = TOUR_TYPES[tour.type]?.split(' ')[0] || 'üó∫Ô∏è';
                return `<div class="card tour-card" data-id="${tourId}">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-green-700 flex-grow"><span>${icon} ${adminMode ? `<input type="text" id="tour-${tourId}-title" value="${tour.title}" class="inline-block w-auto p-1 bg-transparent border-0 border-b focus:ring-0 font-semibold text-xl text-green-700">` : tour.title}</span></h3>
                            ${!adminMode ? `<span id="tour-${tourId}-duration" class="text-base font-medium text-green-800 ml-4 flex-shrink-0"></span>` : ''}
                            <button data-tour-id="${tourId}" class="delete-tour-btn admin-only text-gray-400 hover:text-red-500 p-1" title="Rimuovi tour"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                        </div>
                        ${adminMode ? `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="tour-${tourId}-dep-time">Data/Ora Partenza</label><input type="datetime-local" id="tour-${tourId}-dep-time" value="${tour.depTime || ''}"></div><div><label for="tour-${tourId}-arr-time">Data/Ora Arrivo</label><input type="datetime-local" id="tour-${tourId}-arr-time" value="${tour.arrTime || ''}"></div><div class="md:col-span-2"><label for="tour-${tourId}-type">Tipologia</label><select id="tour-${tourId}-type">${Object.entries(TOUR_TYPES).map(([k, v]) => `<option value="${k}" ${k === tour.type ? 'selected' : ''}>${v}</option>`).join('')}</select></div><div class="md:col-span-2"><label for="tour-${tourId}-description">Descrizione</label><textarea id="tour-${tourId}-description">${tour.description || ''}</textarea></div></div><p id="tour-${tourId}-duration" class="mt-4 text-lg font-semibold text-green-800"></p>` : `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label>Data/Ora Partenza</label><div class="readonly-text">${tour.depTime ? new Date(tour.depTime).toLocaleString('it-IT', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' }) : ''}</div></div><div><label>Data/Ora Arrivo</label><div class="readonly-text">${tour.arrTime ? new Date(tour.arrTime).toLocaleString('it-IT', { day: '2-digit', month: 'long', hour: '2-digit', minute: '2-digit' }) : ''}</div></div><div class="md:col-span-2"><label>Tipologia</label><div class="readonly-text">${TOUR_TYPES[tour.type]}</div></div><div class="md:col-span-2"><label>Descrizione</label><div class="readonly-text">${(tour.description || '').replace(/\n/g, '<br>')}</div></div></div>`}
                    </div>`;
            }).join('');
            container.innerHTML = `${tourCards}<div class="flex justify-center mt-6"><button id="add-tour-btn" class="admin-only px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">Aggiungi Tour</button></div>`;
            (data || []).forEach(tour => {
                const durationEl = document.getElementById(`tour-${tour.id}-duration`);
                if(durationEl) durationEl.textContent = calculateDurationString(tour.depTime, tour.arrTime, null, null);
            });
        }

        function renderBudget(budgetData, adminMode) {
            const container = document.getElementById('budget-content');
            if (!budgetData) { container.innerHTML = '<p>Dati budget non disponibili.</p>'; return; }

            const totalBudget = parseFloat(budgetData.total) || 0;
            const totalPaid = budgetData.expenses.filter(e => e.status === 'paid').reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
            const totalBooked = budgetData.expenses.filter(e => e.status === 'booked').reduce((sum, expense) => sum + (parseFloat(expense.amount) || 0), 0);
            const totalSpent = totalPaid + totalBooked;
            const remaining = totalBudget - totalSpent;
            const paidPercentage = totalBudget > 0 ? (totalPaid / totalBudget) * 100 : 0;
            const bookedPercentage = totalBudget > 0 ? (totalBooked / totalBudget) * 100 : 0;
            const categoryOptions = Object.entries(BUDGET_CATEGORIES).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');
            const adminForm = `<div class="card bg-slate-50 border-indigo-300 admin-only-grid"><h3 class="text-xl font-semibold text-gray-700 mb-4 col-span-full">Aggiungi Nuova Spesa</h3><form id="add-expense-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end"><div class="lg:col-span-2"><label for="expense-desc">Descrizione</label><input type="text" id="expense-desc" required></div><div><label for="expense-amount">Importo (‚Ç¨)</label><input type="number" id="expense-amount" step="0.01" required></div><div><label for="expense-category">Categoria</label><select id="expense-category">${categoryOptions}</select></div><div id="expense-nights-container" class="hidden"><label for="expense-nights">Numero Notti</label><input type="number" id="expense-nights" min="1"></div><div><label for="expense-person">Pagato da</label><input type="text" id="expense-person" required></div><div><label for="expense-status">Stato</label><select id="expense-status"><option value="paid">Pagata</option><option value="booked">Prenotata</option></select></div><div class="flex items-center"><label for="expense-splid" class="flex items-center gap-2 cursor-pointer pt-6"><input type="checkbox" id="expense-splid" class="w-5 h-5"><span>Su Splid?</span></label></div><div class="lg:col-start-4"><button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Aggiungi</button></div></form></div>`;
            const expensesByCategory = budgetData.expenses.reduce((acc, expense) => { (acc[expense.category] = acc[expense.category] || []).push(expense); return acc; }, {});
            const categoryCards = Object.keys(BUDGET_CATEGORIES).map(catKey => {
                const expenses = expensesByCategory[catKey];
                if (!expenses || expenses.length === 0) return '';
                const categoryTotal = expenses.reduce((sum, exp) => sum + (parseFloat(exp.amount) || 0), 0);
                let categoryHeaderInfo = '';
                if (catKey === 'hotels') {
                    const totalNights = expenses.reduce((sum, exp) => sum + (exp.nights || 0), 0);
                    if (totalNights > 0) {
                        const averagePerNight = categoryTotal / totalNights;
                        categoryHeaderInfo = `<p class="text-sm text-gray-500 mb-4">Totale ${totalNights} notti &bull; Media ${formatCurrency(averagePerNight)}/notte</p>`;
                    }
                }
                const expenseItems = expenses.map(exp => {
                    const nightsInfo = (exp.category === 'hotels' && exp.nights && exp.nights > 0) ? `<p class="text-xs text-gray-500 mt-1">${exp.nights} notti &bull; ${formatCurrency(exp.amount / exp.nights)}/notte</p>` : '';
                    return `<li class="expense-item ${exp.onSplid ? 'on-splid' : ''} ${exp.status} p-3 my-1 rounded-md"><div class="flex justify-between items-start"><div class="flex-grow pr-4"><p>${exp.description}</p><p class="text-xs text-gray-500">${exp.person}</p>${nightsInfo}</div><div class="text-right flex-shrink-0"><p class="font-semibold">${formatCurrency(exp.amount)}</p></div></div><div class="admin-only-flex justify-between items-center mt-2 pt-2 border-t border-slate-200"><div class="flex items-center gap-4"><button data-expense-id="${exp.id}" class="status-toggle px-2 py-1 text-xs rounded font-semibold transition-colors ${exp.status === 'paid' ? 'bg-green-200 text-green-800 hover:bg-green-300' : 'bg-amber-200 text-amber-800 hover:bg-amber-300'}">${exp.status === 'paid' ? 'Pagato' : 'Prenotato'}</button><label class="flex items-center gap-1.5 cursor-pointer text-xs text-gray-600"><input type="checkbox" data-expense-id="${exp.id}" class="splid-toggle w-4 h-4 rounded text-indigo-600 focus:ring-indigo-500 focus:ring-offset-0 focus:ring-1" ${exp.onSplid ? 'checked' : ''}>Su Splid</label></div><button data-expense-id="${exp.id}" class="delete-expense-btn text-gray-400 hover:text-red-500" title="Elimina spesa">${TRASH_ICON_SVG}</button></div><div class="user-only flex justify-start items-center gap-2 mt-2 pt-2 border-t border-slate-200 text-xs"><span class="font-semibold px-2 py-0.5 rounded-full ${exp.status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'}">${exp.status === 'paid' ? 'Pagato' : 'Prenotato'}</span>${exp.onSplid ? '<span class="font-semibold px-2 py-0.5 rounded-full bg-slate-200 text-slate-800">Su Splid</span>' : ''}</div></li>`;
                }).join('');
                return `<div class="card"><h4 class="text-lg font-semibold mb-2">${BUDGET_CATEGORIES[catKey]}</h4><p class="text-gray-600 mb-2 font-bold text-xl">${formatCurrency(categoryTotal)}</p>${categoryHeaderInfo}<ul class="text-sm">${expenseItems}</ul></div>`;
            }).join('');
            const summaryByPerson = budgetData.expenses.reduce((acc, { person, category, amount }) => { if (!person) return acc; acc[person] = acc[person] || { total: 0, categories: {} }; acc[person].total += amount; acc[person].categories[category] = (acc[person].categories[category] || 0) + amount; return acc; }, {});
            const summaryByPersonHTML = Object.keys(summaryByPerson).length > 0 ? `<div class="card"><h3 class="text-xl font-semibold text-gray-700 mb-4">Riepilogo per Persona</h3>${Object.entries(summaryByPerson).map(([person, data]) => `<div class="mb-4 pb-4 border-b last:border-b-0"><div class="flex justify-between items-baseline"><h4 class="font-semibold text-lg text-indigo-700">${person}</h4><p class="font-bold text-lg">${formatCurrency(data.total)}</p></div><ul class="text-sm mt-2">${Object.entries(data.categories).map(([cat, catAmount]) => `<li class="flex justify-between text-gray-600 py-1"><span>${BUDGET_CATEGORIES[cat]}</span><span>${formatCurrency(catAmount)}</span></li>`).join('')}</ul></div>`).join('')}</div>` : '';
            container.innerHTML = `<div class="card bg-white border-slate-300"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4"><h2 class="text-2xl font-bold text-gray-800 mb-2 md:mb-0">Riepilogo Budget</h2><div class="flex items-center gap-2"><label for="total-budget-input" class="text-gray-600 font-semibold">Budget Totale:</label><span class="user-only text-2xl font-bold text-indigo-600">${formatCurrency(totalBudget)}</span><input type="number" id="total-budget-input" value="${totalBudget}" step="1" class="admin-only font-bold text-indigo-600 text-xl p-1 w-32"></div></div><div class="mb-3"><div class="progress-bar"><div class="bg-green-500 h-full transition-all duration-500" style="width: ${paidPercentage}%;" title="Pagato: ${formatCurrency(totalPaid)}"></div><div class="bg-amber-500 h-full transition-all duration-500" style="width: ${bookedPercentage}%;" title="Prenotato: ${formatCurrency(totalBooked)}"></div></div></div><div class="flex flex-wrap justify-between text-sm font-semibold gap-x-4 gap-y-1"><div class="text-gray-600">Speso: <span class="font-bold text-green-600">${formatCurrency(totalPaid)}</span> + <span class="font-bold text-amber-500">${formatCurrency(totalBooked)}</span> = <span class="font-bold text-red-500">${formatCurrency(totalSpent)}</span></div><div class="text-gray-600">Rimanente: <span class="font-bold text-blue-600">${formatCurrency(remaining)}</span></div></div></div>${adminMode ? adminForm : ''}<div id="budget-summary-by-person" class="mt-6">${summaryByPersonHTML}</div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">${categoryCards}</div><div id="budget-legend" class="card text-sm mt-6"><h4 class="font-semibold mb-2">Legenda</h4><div class="flex flex-wrap gap-x-4 gap-y-2"><div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: #f0f9ff; border: 1px solid #bae6fd;"></div><span>Spesa inserita su Splid</span></div><div class="flex items-center gap-2"><div class="w-1 h-4 bg-green-500 rounded"></div><span>Spesa Pagata</span></div><div class="flex items-center gap-2"><div class="w-1 h-4 bg-amber-500 rounded"></div><span>Spesa solo Prenotata</span></div></div></div>`;
        }
        
        function renderUsefulLinks(linksData, adminMode) {
            const container = document.getElementById('links-content');
            const linksList = (linksData || []).map(link => `<li class="flex justify-between items-center py-3 border-b border-gray-200 last:border-b-0"><div><a href="${link.url}" target="_blank" class="font-semibold text-indigo-600 hover:text-indigo-800 hover:underline">${link.title}</a><p class="text-sm text-gray-500">${link.url}</p></div><button data-link-id="${link.id}" class="delete-link-btn admin-only text-gray-400 hover:text-red-500 p-2" title="Elimina link">${TRASH_ICON_SVG}</button></li>`).join('');
            container.innerHTML = `<div class="card bg-white border-slate-300"><h2 class="text-2xl font-bold text-gray-800 mb-6">Link Utili</h2>${adminMode ? `<div class="card bg-slate-50 border-indigo-300 mb-6 admin-only-grid"><h3 class="text-xl font-semibold text-gray-700 mb-4">Aggiungi Nuovo Link</h3><form id="add-link-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end"><div class="md:col-span-2"><label for="link-title">Titolo</label><input type="text" id="link-title" required></div><div class="md:col-span-2"><label for="link-url">URL</label><input type="url" id="link-url" required></div><div class="md:col-start-4"><button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Aggiungi Link</button></div></form></div>` : ''}<ul id="useful-links-list">${linksList.length > 0 ? linksList : '<p class="text-gray-500">Nessun link aggiunto.</p>'}</ul></div>`;
        }

        // --- Route Modal Logic ---
        function openRouteModal() {
            tempRoute = [...(currentData.route || [])];
            const select = document.getElementById('route-location-select');
            const uniqueLocations = [...new Set(currentData.itinerary.map(item => item.location).filter(Boolean))];
            select.innerHTML = uniqueLocations.map(loc => `<option value="${loc}">${loc}</option>`).join('');
            renderRouteListInModal();
            document.getElementById('route-modal').classList.remove('hidden');
        }

        function renderRouteListInModal() {
            const listContainer = document.getElementById('route-list');
            if (tempRoute.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500 text-center">Nessuna tappa definita.</p>';
                return;
            }
            listContainer.innerHTML = tempRoute.map((stop, index) => `
                <div class="flex items-center justify-between bg-white p-2 rounded-md mb-2 shadow-sm">
                    <span class="font-medium">${index + 1}. ${stop}</span>
                    <button class="remove-route-stop-btn text-red-500 hover:text-red-700" data-index="${index}">${TRASH_ICON_SVG}</button>
                </div>
            `).join('');
        }

        function closeRouteModal() {
            document.getElementById('route-modal').classList.add('hidden');
            tempRoute = [];
        }

        // --- GESTORI DI EVENTI E HANDLER ---
        async function handleImageUpload(event) {
            const input = event.target;
            const idPrefix = input.id.replace('-image-input', '');
            if (input.files[0]) {
                try {
                    const compressedDataUrl = await compressImage(input.files[0]);
                    applyImageChange(idPrefix, compressedDataUrl);
                    saveData();
                } catch (error) { console.error("Errore nella compressione dell'immagine:", error); }
            }
        }
        function applyImageChange(targetId, imageUrl) {
            if (targetId === 'main') currentData.main.image = imageUrl;
            else {
                const index = parseInt(targetId.replace('day', '')) - 1;
                if (currentData.itinerary[index]) currentData.itinerary[index].image = imageUrl;
            }
            renderImage(targetId, imageUrl);
        }
        function openGitHubModal(targetId) { currentImageTargetId = targetId; document.getElementById('github-modal').style.display = 'flex'; }
        function closeGitHubModal() { document.getElementById('github-modal').style.display = 'none'; document.getElementById('github-image-grid').innerHTML = ''; document.getElementById('github-feedback').textContent = ''; currentImageTargetId = null; }
        async function fetchGitHubImages() {
            const user = document.getElementById('github-user').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const grid = document.getElementById('github-image-grid');
            const feedback = document.getElementById('github-feedback');
            const fetchBtn = document.getElementById('fetch-github-images-btn');
            if (!user || !repo) { feedback.textContent = 'Per favore, inserisci nome utente e repository.'; feedback.className = 'text-red-500 text-sm mb-2'; return; }
            feedback.textContent = 'Caricamento immagini...'; feedback.className = 'text-blue-500 text-sm mb-2'; grid.innerHTML = ''; fetchBtn.disabled = true;
            try {
                const response = await fetch(`https://api.github.com/repos/${user}/${repo}/contents`);
                if (!response.ok) throw new Error(`Errore: ${response.statusText}`);
                const data = await response.json();
                const imageFiles = data.filter(file => /\.(jpe?g|png|gif|webp)$/i.test(file.name));
                if (imageFiles.length === 0) { feedback.textContent = 'Nessuna immagine trovata nel repository.'; feedback.className = 'text-yellow-500 text-sm mb-2'; return; }
                feedback.textContent = `Trovate ${imageFiles.length} immagini. Clicca per selezionare.`; feedback.className = 'text-green-600 text-sm mb-2';
                imageFiles.forEach(file => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'cursor-pointer border-2 border-transparent hover:border-indigo-500 rounded-lg overflow-hidden';
                    imgContainer.innerHTML = `<img src="${file.download_url}" alt="${file.name}" class="w-full h-full object-cover">`;
                    imgContainer.addEventListener('click', () => { applyImageChange(currentImageTargetId, file.download_url); saveData(); closeGitHubModal(); });
                    grid.appendChild(imgContainer);
                });
            } catch (error) { console.error('Errore API GitHub:', error); feedback.textContent = `Errore nel caricamento: ${error.message}`; feedback.className = 'text-red-500 text-sm mb-2'; } 
            finally { fetchBtn.disabled = false; }
        }
        
        function handleDateUpdate() {
            const startDate = document.getElementById('start-date-input').value;
            const endDate = document.getElementById('end-date-input').value;
            if (!startDate || !endDate) { alert("Per favore, seleziona sia la data di inizio che quella di fine."); return; }
            const start = new Date(startDate); const end = new Date(endDate);
            if (start > end) { alert("La data di fine non pu√≤ essere precedente alla data di inizio."); return; }
            const newItinerary = [];
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                const dateString = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().split('T')[0];
                const existingDay = currentData.itinerary.find(day => day.date === dateString) || { date: dateString, location: "Da definire", isFlight: false, isCruise: false, accommodation: "", activities: "", image: "" };
                newItinerary.push(existingDay);
            }
            currentData.itinerary = newItinerary;
            createDetailedItinerary(currentData.itinerary, true);
            updateCalendar(currentData.itinerary);
            setupDynamicEventListeners();
            saveData();
        }

        function addFlight() { currentData.flights.push({ idPrefix: `flight_${Date.now()}`, title: "Nuovo Volo", depAirport: "", arrAirport: "", depTime: "", arrTime: "", depTz: 1, arrTz: 1 }); renderApp(currentData, isAdminMode); }
        function removeFlight(idPrefix) { if (confirm("Sei sicuro di voler rimuovere questo volo?")) { currentData.flights = currentData.flights.filter(f => f.idPrefix !== idPrefix); renderApp(currentData, isAdminMode); saveData(); } }
        function addTour() { currentData.tours.push({ id: Date.now(), title: "Nuovo Tour", depTime: "", arrTime: "", type: "boat", description: "" }); renderApp(currentData, isAdminMode); }
        function removeTour(tourId) { if (confirm("Sei sicuro di voler rimuovere questo tour?")) { currentData.tours = currentData.tours.filter(t => t.id !== tourId); renderApp(currentData, isAdminMode); saveData(); } }
        
        function updateFlightSummaryTable() {
            const tableBody = document.querySelector('#flights-summary-table tbody');
            if (!tableBody) return;
            const flightData = buildDataObjectFromDOM().flights;
            tableBody.innerHTML = flightData.map(flight => `<tr class="border-b last:border-b-0"><td class="py-2 pr-4 font-medium">${flight.title}</td><td class="py-2 pl-4 text-right">${calculateDurationString(flight.depTime, flight.arrTime, flight.depTz, flight.arrTz)}</td></tr>`).join('');
        }

        function setupStaticEventListeners() {
            document.getElementById('reset-btn').addEventListener('click', resetItinerary);
            document.getElementById('pdf-btn').addEventListener('click', () => document.getElementById('pdf-quality-modal').classList.remove('hidden'));
            document.getElementById('export-html-btn').addEventListener('click', exportHTML);
            document.getElementById('apply-dates-btn').addEventListener('click', handleDateUpdate);
            document.getElementById('define-route-btn').addEventListener('click', openRouteModal);
            
            document.getElementById('export-json-btn').addEventListener('click', exportJSON);
            document.getElementById('import-json-btn').addEventListener('click', () => document.getElementById('import-json-input').click());
            document.getElementById('import-json-input').addEventListener('change', handleJSONImport);

            const allBtns = document.querySelectorAll('.tab-button');
            const allContents = document.querySelectorAll('#main-content > section');
            allBtns.forEach(btn => btn.addEventListener('click', () => {
                const targetId = btn.id.replace('tab-btn-', '') + '-content';
                allContents.forEach(content => content.classList.toggle('hidden', content.id !== targetId));
                allBtns.forEach(b => b.classList.toggle('active', b === btn));
            }));
            
            document.getElementById('fetch-github-images-btn').addEventListener('click', fetchGitHubImages);
            document.getElementById('close-github-modal-btn').addEventListener('click', closeGitHubModal);
            document.getElementById('pdf-quality-cancel-btn').addEventListener('click', () => document.getElementById('pdf-quality-modal').classList.add('hidden'));
            document.querySelectorAll('.pdf-quality-btn').forEach(btn => btn.addEventListener('click', () => {
                document.getElementById('pdf-quality-modal').classList.add('hidden');
                saveAsPDF(PDF_QUALITY_PRESETS[btn.dataset.quality]);
            }));

            // Route Modal Listeners
            document.getElementById('route-cancel-btn').addEventListener('click', closeRouteModal);
            document.getElementById('route-save-btn').addEventListener('click', () => {
                currentData.route = [...tempRoute];
                saveData();
                initializeMap(currentData.itinerary);
                closeRouteModal();
            });
            document.getElementById('add-route-stop-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedLocation = document.getElementById('route-location-select').value;
                if (selectedLocation) {
                    tempRoute.push(selectedLocation);
                    renderRouteListInModal();
                }
            });
            document.getElementById('route-list').addEventListener('click', (e) => {
                if (e.target.closest('.remove-route-stop-btn')) {
                    const index = parseInt(e.target.closest('.remove-route-stop-btn').dataset.index);
                    tempRoute.splice(index, 1);
                    renderRouteListInModal();
                }
            });
        }

        function setupDynamicEventListeners() {
            document.body.removeEventListener('input', handleDynamicInput);
            document.body.removeEventListener('change', handleDynamicChange);
            document.body.removeEventListener('submit', handleDynamicSubmit);
            document.body.removeEventListener('click', eventDelegationHandler);
            document.body.addEventListener('input', handleDynamicInput);
            document.body.addEventListener('change', handleDynamicChange);
            document.body.addEventListener('submit', handleDynamicSubmit);
            document.body.addEventListener('click', eventDelegationHandler);
        }

        function handleDynamicInput(e) {
            if (e.target.matches('textarea')) autoGrowTextarea(e.target);
            if (e.target.matches('input[id$="-airport"], input[id$="-accommodation"]')) updateGmapsLink(e.target);
            if (e.target.id === 'total-budget-input') { currentData.budget.total = parseFloat(e.target.value) || 0; renderBudget(currentData.budget, isAdminMode); saveData(); }
            if (e.target.closest('.flight-card')) updateFlightSummaryTable();
            if (e.target.closest('.tour-card')) {
                const card = e.target.closest('.tour-card');
                const tourId = card.dataset.id;
                const durationEl = document.getElementById(`tour-${tourId}-duration`);
                if (durationEl) {
                    const depTime = document.getElementById(`tour-${tourId}-dep-time`).value;
                    const arrTime = document.getElementById(`tour-${tourId}-arr-time`).value;
                    durationEl.textContent = calculateDurationString(depTime, arrTime, null, null);
                }
            }
        }

        function handleDynamicChange(e) {
            if (e.target.matches('input[type="file"]') && e.target.id !== 'import-json-input') handleImageUpload(e);
            if (e.target.matches('input[id$="-flight-check"], input[id$="-cruise-check"]')) { saveData(); updateCalendar(currentData.itinerary); }
            if (e.target.closest('.flight-card, .tour-card')) { if (e.target.closest('.flight-card')) updateFlightSummaryTable(); saveData(); }
            if (e.target.matches('.splid-toggle')) {
                const expenseId = parseInt(e.target.dataset.expenseId);
                const expense = currentData.budget.expenses.find(exp => exp.id === expenseId);
                if (expense) {
                    expense.onSplid = e.target.checked;
                    renderBudget(currentData.budget, isAdminMode);
                    saveData();
                }
            }
            if (e.target.id === 'expense-category') {
                const nightsContainer = document.getElementById('expense-nights-container');
                if (nightsContainer) {
                    if (e.target.value === 'hotels') {
                        nightsContainer.classList.remove('hidden');
                    } else {
                        nightsContainer.classList.add('hidden');
                    }
                }
            }
        }

        function handleDynamicSubmit(e) {
            if (e.target.id === 'add-expense-form') {
                e.preventDefault();
                const newExpense = {
                    id: Date.now(),
                    description: document.getElementById('expense-desc').value,
                    amount: parseFloat(document.getElementById('expense-amount').value),
                    category: document.getElementById('expense-category').value,
                    person: document.getElementById('expense-person').value.trim(),
                    status: document.getElementById('expense-status').value,
                    onSplid: document.getElementById('expense-splid').checked
                };
                if (newExpense.category === 'hotels') {
                    const nightsInput = document.getElementById('expense-nights');
                    newExpense.nights = nightsInput && nightsInput.value ? parseInt(nightsInput.value, 10) : 0;
                }
                currentData.budget.expenses.push(newExpense);
                renderBudget(currentData.budget, isAdminMode);
                saveData();
                e.target.reset();
                document.getElementById('expense-nights-container')?.classList.add('hidden');
            }
            if (e.target.id === 'add-link-form') {
                e.preventDefault();
                currentData.usefulLinks.push({ id: Date.now(), title: document.getElementById('link-title').value, url: document.getElementById('link-url').value });
                renderUsefulLinks(currentData.usefulLinks, isAdminMode);
                saveData();
                e.target.reset();
            }
        }

        function eventDelegationHandler(e) {
            const popupDateLink = e.target.closest('.popup-date-link');
            if (popupDateLink) {
                e.preventDefault();
                const date = popupDateLink.dataset.date;
                if (date) {
                    document.getElementById('tab-btn-itinerary').click();
                    if (map) map.closePopup();
                    setTimeout(() => {
                        const targetCard = document.querySelector(`.day-card-wrapper[data-date="${date}"]`);
                        if (targetCard) {
                            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            targetCard.style.transition = 'background-color 0.5s ease-in-out';
                            targetCard.style.backgroundColor = '#e0e7ff'; // A light indigo
                            setTimeout(() => {
                                targetCard.style.backgroundColor = '';
                            }, 2000); // Highlight for 2 seconds
                        }
                    }, 150);
                }
            }

            const githubBtn = e.target.closest('.github-open-btn');
            if (githubBtn) openGitHubModal(githubBtn.dataset.targetId);

            const removeBtn = e.target.closest('.remove-image-btn');
            if (removeBtn) { applyImageChange(removeBtn.dataset.targetId, ''); saveData(); }

            const tripDay = e.target.closest('.trip-day');
            if(tripDay && tripDay.dataset.date) {
                document.getElementById('tab-btn-itinerary').click();
                setTimeout(() => {
                    const targetCard = document.querySelector(`.day-card-wrapper[data-date="${tripDay.dataset.date}"]`);
                    if(targetCard) targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            }
            
            const statusToggle = e.target.closest('.status-toggle');
            if (statusToggle) {
                const expenseId = parseInt(statusToggle.dataset.expenseId);
                const expense = currentData.budget.expenses.find(exp => exp.id === expenseId);
                if (expense) {
                    expense.status = expense.status === 'paid' ? 'booked' : 'paid';
                    renderBudget(currentData.budget, isAdminMode);
                    saveData();
                }
            }

            const deleteExpenseBtn = e.target.closest('.delete-expense-btn');
            if (deleteExpenseBtn) {
                const expenseId = parseInt(deleteExpenseBtn.dataset.expenseId);
                currentData.budget.expenses = currentData.budget.expenses.filter(exp => exp.id !== expenseId);
                renderBudget(currentData.budget, isAdminMode);
                saveData();
            }

            const deleteLinkBtn = e.target.closest('.delete-link-btn');
            if (deleteLinkBtn) {
                const linkId = parseInt(deleteLinkBtn.dataset.linkId);
                currentData.usefulLinks = currentData.usefulLinks.filter(link => link.id !== linkId);
                renderUsefulLinks(currentData.usefulLinks, isAdminMode);
                saveData();
            }

            if (e.target.closest('#add-flight-btn')) addFlight();
            const deleteFlightBtn = e.target.closest('.delete-flight-btn');
            if (deleteFlightBtn) removeFlight(deleteFlightBtn.dataset.flightId);
            
            if (e.target.closest('#add-tour-btn')) addTour();
            const deleteTourBtn = e.target.closest('.delete-tour-btn');
            if (deleteTourBtn) removeTour(parseInt(deleteTourBtn.dataset.tourId));

            const centerMapBtn = e.target.closest('.center-map-btn');
            if (centerMapBtn) {
                const lat = centerMapBtn.dataset.lat;
                const lng = centerMapBtn.dataset.lng;
                centerMapOnLocation(lat, lng);
                document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        // --- LOGICA DI INIZIALIZZAZIONE E AVVIO ---
        function handleSiteLogin(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('site-access-password-input');
            if (passwordInput.value === SITE_ACCESS_PASSWORD) {
                sessionStorage.setItem('siteAccessGranted', 'true');
                document.getElementById('site-access-modal').classList.add('hidden');
                document.body.classList.remove('content-hidden');
                initializeApp();
            } else {
                document.getElementById('site-access-password-error').classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function handleAdminLogin(event) {
            event.preventDefault();
            const passwordInput = document.getElementById('admin-password-input');
            if (passwordInput.value === ADMIN_PASSWORD) {
                sessionStorage.setItem('isAdmin', 'true');
                document.getElementById('admin-modal').classList.add('hidden');
                document.getElementById('admin-password-error').classList.add('hidden');
                passwordInput.value = '';
                renderApp(currentData, true);
            } else {
                document.getElementById('admin-password-error').classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        function handleAdminLogout() { saveData(); sessionStorage.removeItem('isAdmin'); renderApp(currentData, false); }
        
        async function initializeApp() {
            isAdminMode = sessionStorage.getItem('isAdmin') === 'true';
            currentData = await loadData();
            if(!currentData.usefulLinks) currentData.usefulLinks = [];
            if(!currentData.tours) currentData.tours = [];
            if(!currentData.route) currentData.route = [];
            renderApp(currentData, isAdminMode);
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('site-access-form').addEventListener('submit', handleSiteLogin);
            document.getElementById('admin-login-btn').addEventListener('click', () => { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-password-input').focus(); });
            document.getElementById('admin-logout-btn').addEventListener('click', handleAdminLogout);
            document.getElementById('admin-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('admin-cancel-btn').addEventListener('click', () => document.getElementById('admin-modal').classList.add('hidden'));
            
            setupStaticEventListeners();

            if (sessionStorage.getItem('siteAccessGranted') === 'true') {
                document.getElementById('site-access-modal').classList.add('hidden');
                document.body.classList.remove('content-hidden');
                initializeApp();
            } else {
                document.getElementById('site-access-password-input').focus();
            }
        });
    </script>
</body>
</html>
